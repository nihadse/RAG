import streamlit as st
from datetime import datetime
import html

user_input = st.chat_input("Type your message here...")

if user_input and st.session_state.current_chat:
    timestamp = datetime.now()

    # Add user message
    st.session_state.chat_sessions[st.session_state.current_chat].append({
        "role": "user",
        "content": user_input,
        "timestamp": timestamp
    })

    # Get assistant response
    with st.spinner("Thinking..."):
        response = rag_chatbot(user_input)

    answer = response["answer"]
    escaped_answer = html.escape(answer)

    # Display the assistant message nicely
    st.markdown("**Assistant:**")
    st.markdown(answer)

    # Copy to clipboard button
    copy_html = f"""
    <textarea id="copyTarget" style="position: absolute; left: -1000px;">{escaped_answer}</textarea>
    <button onclick="navigator.clipboard.writeText(document.getElementById('copyTarget').value)">ğŸ“‹ Copier la rÃ©ponse</button>
    """
    st.markdown(copy_html, unsafe_allow_html=True)

    # Display timestamp
    st.markdown(f"*RÃ©ponse gÃ©nÃ©rÃ©e Ã  : {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*")

    # Save assistant response
    st.session_state.chat_sessions[st.session_state.current_chat].append({
        "role": "assistant",
        "content": answer,
        "sources": response["sources"],
        "evaluation": response["evaluation"],
        "timestamp": datetime.now()
    })

    st.rerun()






import streamlit as st
from datetime import datetime

user_input = st.chat_input("Type your message here...")

if user_input and st.session_state.current_chat:
    timestamp = datetime.now()

    # Add user message
    st.session_state.chat_sessions[st.session_state.current_chat].append({
        "role": "user",
        "content": user_input,
        "timestamp": timestamp
    })

    # Get assistant response
    with st.spinner("Thinking..."):
        response = rag_chatbot(user_input)

    answer = response["answer"]

    # Display the assistant response
    st.markdown(f"**Assistant:** {answer}")

    # Copy button using HTML + JS
    copy_code = f"""
    <textarea id="toCopy" style="position:absolute; left:-1000px;">{answer}</textarea>
    <button onclick="navigator.clipboard.writeText(document.getElementById('toCopy').value)">ğŸ“‹ Copy Response</button>
    """
    st.markdown(copy_code, unsafe_allow_html=True)

    # Show timestamp
    st.markdown(f"**RÃ©ponse gÃ©nÃ©rÃ©e Ã  :** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

    # Save assistant response
    st.session_state.chat_sessions[st.session_state.current_chat].append({
        "role": "assistant",
        "content": answer,
        "sources": response["sources"],
        "evaluation": response["evaluation"],
        "timestamp": datetime.now()
    })

    st.rerun()
