import os
import pandas as pd
import xlwings as xw

# === CONFIGURATION ===
csv_path = "path/to/your_data.csv"
excel_folder = "path/to/excel/files"
output_folder = "path/to/save/updated/files"

# === FLEXIBLE HEADER GROUPS ===
inscription_cols = ["NÂ° d'inscription", "N", "NUM", "Ø§Ù„Ø±Ù‚Ø©", "Ø±Ù‚Ø©", "NÂ°"]
ad_cols = ["Adresse du commerce", "Adresse domicile", "Adresse du Local", "Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ¬Ø§Ø±ÙŠ"]
engagement_cols = ["Remarque", "Ù…Ù„Ø§Ø­Ø¸Ø©", "Ù…Ù„Ø§Ø­Ø¸Ø§Øª"]

# Arabic columns to fill
bank_dom_yn_cols = ["Ù‡Ù„ Ù‚Ø§Ù… Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„ Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ø¨ØªÙˆØ·ÙŠÙ† Ø¨Ù†ÙƒÙŠ Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ø³ØªÙŠØ±Ø§Ø¯"]
bank_dom_date_cols = ["ØªØ§Ø±ÙŠØ® Ø§Ø®Ø± Ø¨ØªÙˆØ·ÙŠÙ† Ø¨Ù†ÙƒÙŠ Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ø³ØªÙŠØ±Ø§Ø¯"]
loan_yn_cols = ["Ù‡Ù„ Ø§Ø³ØªÙØ§Ø¯ Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„ Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ù…Ù† Ù‚Ø±Ø¶ Ø¨Ù†ÙƒÙŠ"]
loan_date_cols = ["ØªØ§Ø±ÙŠØ® Ø§Ø®Ø± Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ù‚Ø±Ø¶ Ø¨Ù†ÙƒÙŠ"]

# === LOAD CSV DATA ===
csv_df = pd.read_csv(csv_path, dtype=str).fillna("")
csv_df.set_index("inscription", inplace=True)

# === LOOP OVER EXCEL FILES ===
for file in os.listdir(excel_folder):
    if not file.endswith(".xlsx"):
        continue

    file_path = os.path.join(excel_folder, file)
    app = xw.App(visible=False)
    wb = app.books.open(file_path)

    print(f"ğŸ“‚ Processing: {file}")

    for sheet in wb.sheets:
        found_header = False
        header_row = None
        header_map = {}

        # Detect header row (first 50 rows)
        for row in range(1, 51):
            row_values = sheet.range(f"A{row}").expand("right").value
            if not row_values:
                continue
            for val in row_values:
                if val in inscription_cols:
                    header_row = row
                    found_header = True
                    break
            if found_header:
                break

        if not found_header:
            print(f"âš ï¸ No header found in {file} / Sheet: {sheet.name}")
            continue

        headers = sheet.range(f"A{header_row}").expand("right").value

        # === MAP COLUMNS ===
        for idx, name in enumerate(headers):
            if name in inscription_cols:
                header_map["inscription"] = idx + 1
            elif name in ad_cols:
                header_map["address_"] = idx + 1
            elif name in engagement_cols:
                header_map["engagement_"] = idx + 1
            elif name in bank_dom_yn_cols:
                header_map["bank_dom_yn"] = idx + 1
            elif name in bank_dom_date_cols:
                header_map["bank_dom_date"] = idx + 1
            elif name in loan_yn_cols:
                header_map["loan_yn"] = idx + 1
            elif name in loan_date_cols:
                header_map["loan_date"] = idx + 1

        if "inscription" not in header_map:
            print(f"âŒ 'inscription' column not found in {file} / Sheet: {sheet.name}")
            continue

        # === FILL SHEET ROWS ===
        row = header_row + 1
        while True:
            cell_value = sheet.range((row, header_map["inscription"])).value
            if not cell_value:
                break

            key = str(cell_value).strip()
            if key in csv_df.index:
                for field in ["address_", "engagement_", "bank_dom_yn", "bank_dom_date", "loan_yn", "loan_date"]:
                    if field in header_map and field in csv_df.columns:
                        sheet.range((row, header_map[field])).value = csv_df.at[key, field]
            row += 1

    # === SAVE AND CLOSE ===
    output_path = os.path.join(output_folder, file)
    wb.save(output_path)
    wb.close()
    app.quit()
    print(f"âœ… Saved updated file: {output_path}")






Bonjour [Nom],

Je serai en congÃ© la semaine prochaine. Merci de bien vouloir mâ€™envoyer les demandes ServiceNow par email pendant cette pÃ©riode.

Bien cordialement,
Nihad

Objet : Reprogrammation de notre rÃ©union

Bonjour [Nom],

La rÃ©union prÃ©vue la derniÃ¨re fois nâ€™ayant pas eu lieu, nous souhaiterions la reprogrammer pour ce jeudi (demain), si cela vous convient.

N'hÃ©sitez pas Ã  nous transmettre vos disponibilitÃ©s.

Bien cordialement,
[Votre prÃ©nom et nom]
[Votre poste]
[Votre entreprise]


Bonjour,

Je vous informe que les informations de contact ont bien Ã©tÃ© ajoutÃ©es au fichier.
Nâ€™hÃ©sitez pas Ã  me faire savoir si vous avez besoin de prÃ©cisions supplÃ©mentaires.




Bonjour [Nom],

Veuillez trouver ci-joint le fichier en annexe, comme convenu.

Je vous remercie et reste Ã  votre disposition pour toute information complÃ©mentaire.

Bien cordialement,
Nihad Senhadji


Salut,
Je tâ€™informe que la mise Ã  jour a Ã©tÃ© faite via le fichier QAC situÃ© ici : [chemin/du/fichier/QAC].

Ã€ bientÃ´t,
Nihad



Right([YourField], 2) + 
Left(Right([YourField], 3), 1) + 
Left([YourField], Length([YourField]) - 3)



Bonjour [Nom],
Je vous informe que la date de dÃ©part prÃ©vue est le 15 juillet 2025, merci encore pour votre aide.

Bien cordialement,
Nihad Senhadji




Right([YourField], 2) + 
Left(Right([YourField], 3), 1) + 
Substring([YourField], 6, Length([YourField]) - 9) + 
Left([YourField], 6)




Right([YourField], 2) +
Left(Right([YourField], 3), 1) +
Left([YourField], Length([YourField]) - 3)




Right([YourField], 2) +
Left(Right([YourField], 3), 1) +
Replace(Left([YourField], Length([YourField]) - 3), " ", "")




LEFT([YourField], FINDSTRING([YourField], "/") - 1)

TRIM(RIGHT([Code], 3)) 
+ TRIM(SUBSTRING([Code], 6, FINDSTRING([Code], " ") - 6)) 
+ "-" 
+ LEFT([Code], 5)

Demande de rendez-vous pour dÃ©pÃ´t de visa France


RIGHT([Code], 3) 
+ SUBSTRING([Code], 6, FINDSTRING([Code], " ") - 6) 
+ "-" 
+ LEFT([Code], 5)


REGEX_Replace([YourField], "(\d{2}/\d{2})-(\d{7,9})([A-Da-d])", "$2$3-$1")


Bonjour [Nom],

Je vous contacte Ã  propos du rendez-vous pour le dÃ©pÃ´t de visa France.
Jâ€™ai dÃ©jÃ  finalisÃ© la procÃ©dure sur Capago et je sollicite votre aide pour obtenir un rendez-vous.
Merci beaucoup pour votre soutien.

Bien cordialement,
Nihad Senhadji




\d{2}[A-D]\d{7}-\d{2}/\d{2}




\d{2}[A-D]\d{7}-\d{2}\+\d{2}/\d{2}



(?<![^\s])\d{10}-\d{2}\+\d{2}/\d{2}(?![^\s])



(?<![^\s])\d{10}-\d{2}\+\d{2}/\d{2}(?![^\s])


Bonjour Youcef,

Merci pour ton message.
Nous avons eu un incident sur les fichiers GESKYC, d'oÃ¹ le retard.
Nous ferons en sorte de vous les transmettre le 8 de chaque mois comme convenu.
Merci pour ta comprÃ©hension.

Bien Ã  toi,
Nihad



RIGHT([YourField], 10) + " -" + LEFT([YourField], 5)



\b\d{2}/\d{2}-\d{2}[A-Da-d]\d{7}\b


LEFT([YourField],10) + "-" + MID([YourField],11,2) + "/00"



(?<![\dA-Za-z/-])\d{2}[A-Da-d]\d{7}-\d{2}(?![\dA-Za-z/-])



(?<![^\s])\d{2}[A-Da-d]\d{7}-\d{2}(?![^\s])



(?<![^\s])\d{2}[A-D]\d{7}(?![^\s])



(?<![\dA-Z/-])\d{2}[A-D]\d{7}(?![\d/-])




(?<![-/\d])\b\d{2}[A-D]\d{7}\b(?![-/\d])



(?<![-/\d])\b02[A-D]\d{7}\b(?![-/\d])



import re

def clean_register_commerce_v2(value):
    if not isinstance(value, str):
        return value

    value = value.strip().upper()

    # Step 1: Replace multiple slashes with a single slash
    value = re.sub(r"/{2,}", "/", value)

    # Step 2: Handle format like "16/A/1185168" or "01/A/113040 -01/05"
    match1 = re.match(r"^(\d{2})/([A-Z])/([0-9 ]+)(.*)", value)
    if match1:
        return match1.group(1) + match1.group(2) + match1.group(3) + match1.group(4)

    # Step 3: Handle format like "05/00-1125555A00" or "05/00/1125555A00"
    match2 = re.match(r"^(\d{2}/\d{2})[-/]?(\d+)([A-Z])(\d{2})$", value)
    if match2:
        return match2.group(4) + match2.group(3) + match2.group(2) + "-" + match2.group(1)

    return value  # Return original if no patterns matched









import re

def clean_register_commerce_v2(value):
    if not isinstance(value, str):
        return value

    value = value.strip().upper().replace(" ", " ")  # preserve intentional spaces

    # Clean up repeated slashes like "//A/"
    value = re.sub(r"/{2,}", "/", value)

    # Case 1: XX/A/NUMBER or similar
    match1 = re.match(r"^(\d{2})/([A-Z])/([0-9 ]+)(.*)", value)
    if match1:
        return match1.group(1) + match1.group(2) + match1.group(3) + match1.group(4)

    # Case 2: handles format like 05/00-1125555A00
    match2 = re.match(r"^(\d{2}/\d{2})-?(\d+)([A-Z])(\d{2})$", value)
    if match2:
        return match2.group(4) + match2.group(3) + match2.group(2) + "-" + match2.group(1)

    return value  # return unchanged if nothing matches







import re

def clean_register_commerce(value):
    if not isinstance(value, str):
        return value

    value = value.strip().upper().replace(" ", "")

    # Case 1: format like "16/A/1185168"
    match1 = re.match(r"^(\d{2})/([A-Z])/(\d+)$", value)
    if match1:
        return match1.group(1) + match1.group(2) + match1.group(3)

    # Case 2: format like "05/00-1125555A00"
    match2 = re.match(r"^(\d{2}/\d{2})-?(\d+)([A-Z])(\d{2})$", value)
    if match2:
        return match2.group(4) + match2.group(3) + match2.group(2) + "-" + match2.group(1)

    return value  # Return unchanged if format is not matched






def convert_arabic_to_french(text):
    if not isinstance(text, str):
        return text

    # If already well formatted (contains a Latin letter and no Arabic), return as is
    contains_latin = any(c.isalpha() and c.upper() in 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' for c in text)
    contains_arabic = any('\u0600' <= c <= '\u06FF' for c in text)

    if contains_latin and not contains_arabic:
        return text  # Already formatted, skip transformation

    # Else: process Arabic version
    text = text.replace(" ", "")

    arabic_to_french = {
        "Ø£": "A", "Ø§": "A", "Ø¢": "A",
        "Ø¨": "B", "Øª": "T", "Ø«": "S",
        "Ø¬": "J", "Ø­": "H", "Ø®": "KH",
        "Ø¯": "D", "Ø°": "DH", "Ø±": "R",
        "Ø²": "Z", "Ø³": "S", "Ø´": "CH",
        "Øµ": "S", "Ø¶": "D", "Ø·": "T",
        "Ø¸": "Z", "Ø¹": "A", "Øº": "GH",
        "Ù": "F", "Ù‚": "K", "Ùƒ": "K",
        "Ù„": "L", "Ù…": "M", "Ù†": "N",
        "Ù‡": "H", "Ùˆ": "W", "ÙŠ": "Y"
    }

    digits = ''.join(c for c in text if c.isdigit())
    arabic_letters = ''.join(c for c in text if '\u0600' <= c <= '\u06FF')
    converted_letters = ''.join(arabic_to_french.get(c, c) for c in arabic_letters)

    first_two = digits[:2]
    remaining_digits = digits[2:]

    return first_two + converted_letters + remaining_digits






def convert_arabic_to_french(text):
    if not isinstance(text, str):
        return text

    text = text.replace(" ", "")

    arabic_to_french = {
        "Ø£": "A", "Ø§": "A", "Ø¢": "A",
        "Ø¨": "B", "Øª": "T", "Ø«": "S",
        "Ø¬": "J", "Ø­": "H", "Ø®": "KH",
        "Ø¯": "D", "Ø°": "DH", "Ø±": "R",
        "Ø²": "Z", "Ø³": "S", "Ø´": "CH",
        "Øµ": "S", "Ø¶": "D", "Ø·": "T",
        "Ø¸": "Z", "Ø¹": "A", "Øº": "GH",
        "Ù": "F", "Ù‚": "K", "Ùƒ": "K",
        "Ù„": "L", "Ù…": "M", "Ù†": "N",
        "Ù‡": "H", "Ùˆ": "W", "ÙŠ": "Y"
    }

    # Separate digits and Arabic letters
    digits = ''.join(c for c in text if c.isdigit())
    arabic_letters = ''.join(c for c in text if '\u0600' <= c <= '\u06FF')
    converted_letters = ''.join(arabic_to_french.get(c, c) for c in arabic_letters)

    # First 2 digits
    first_two = digits[:2]
    remaining_digits = digits[2:]

    return first_two + converted_letters + remaining_digits










import pandas as pd

# Your existing function
def convert_arabic_to_french(text):
    if not isinstance(text, str):
        return text

    text = text.replace(" ", "")

    arabic_to_french = {
        "Ø£": "A", "Ø§": "A", "Ø¢": "A",
        "Ø¨": "B", "Øª": "T", "Ø«": "S",
        "Ø¬": "J", "Ø­": "H", "Ø®": "KH",
        "Ø¯": "D", "Ø°": "DH", "Ø±": "R",
        "Ø²": "Z", "Ø³": "S", "Ø´": "CH",
        "Øµ": "S", "Ø¶": "D", "Ø·": "T",
        "Ø¸": "Z", "Ø¹": "A", "Øº": "GH",
        "Ù": "F", "Ù‚": "K", "Ùƒ": "K",
        "Ù„": "L", "Ù…": "M", "Ù†": "N",
        "Ù‡": "H", "Ùˆ": "W", "ÙŠ": "Y"
    }

    digits = ''.join(c for c in text if c.isdigit())[:2]
    arabic_letters = ''.join(c for c in text if '\u0600' <= c <= '\u06FF')
    converted_letters = ''.join(arabic_to_french.get(c, c) for c in arabic_letters)

    return digits + converted_letters

# Example DataFrame
df = pd.DataFrame({
    'original': ["22Ø¨  ", "Ø¨11", "Ø¢33", "Ø¨643", "Ø£9Ø²", "hello"]
})

# Apply function to column
df['converted'] = df['original'].apply(convert_arabic_to_french)





# Show result
print(df)
import pandas as pd
import unicodedata
import re

# Sample input
df = pd.DataFrame({
    'your_column': ["42 / 00 - 2641809111", None]
})

# Step 1: Fill missing values
df['your_column'] = df['your_column'].fillna('')

# Step 2: Normalize and remove ALL space-like Unicode characters
def remove_all_whitespace(text):
    # Normalize the string to NFKC form (to expose hidden chars)
    normalized = unicodedata.normalize('NFKC', text)
    # Remove ALL known whitespace characters and invisible formatting marks
    return re.sub(r'[\s\u200f\u200e\u200b\u00a0\u202f\u2060]+', '', normalized)

df['your_column'] = df['your_column'].apply(remove_all_whitespace)

print(df)



import pandas as pd
import re

# Sample DataFrame
df = pd.DataFrame({
    'your_column': ["0127 /01-0105182 Ø¨", None, "   Ù†Ù‡Ø§Ø¯Â 123", "\u200fÙ†Øµ Ù…Ø¹ RTL"]  # note: includes Unicode spaces
})

# Step 1: Replace NaN/NA with empty string
df['your_column'] = df['your_column'].fillna('')

# Step 2: Remove ALL Unicode whitespace (includes Arabic RTL marks, zero-width spaces, etc.)
# \s matches visible whitespace, \u200f, \u200b, \xa0 etc. handled explicitly
df['your_column'] = df['your_column'].apply(
    lambda x: re.sub(r'[\s\u200f\u200e\u200b\u00a0]+', '', x)
)

print(df)


import pandas as pd

# Example DataFrame with Arabic and numbers
df = pd.DataFrame({
    'your_column': [" Ù†Ù‡Ø§Ø¯", "Sheu3873 43", "  Ø­ Ø¬ h65", "\u200FØ§Ù„Ø³Ù„Ø§Ù… 123"]
})

# Remove all whitespace characters (normal and Unicode)
df['your_column'] = df['your_column'].apply(lambda x: ''.join(ch for ch in x if not ch.isspace()))

print(df)



import pandas as pd

# Example DataFrame
df = pd.DataFrame({
    'your_column': [" nihad", "Sheu3873 43", "  hg h65"]
})

# Remove all whitespace characters
df['your_column'] = df['your_column'].str.replace(r'\s+', '', regex=True)

print(df)

import pandas as pd

# Example DataFrame
df = pd.DataFrame({
    'your_column': [" nihad", "Sheu3873 43", "  hg h65"]
})

# Remove leading spaces
df['your_column'] = df['your_column'].str.lstrip()

print(df)


Bonjour [Nom],
Nous avions une rÃ©union prÃ©vue aujourdâ€™hui Ã  11h, mais vous nâ€™Ã©tiez pas prÃ©sent(e) et nous nâ€™avons pas rÃ©ussi Ã  vous joindre.
Pouvez-vous me proposer un crÃ©neau pour reprogrammer notre Ã©change ?





import pandas as pd

# Sample DataFrame with "Registre de commerce" values
df = pd.DataFrame({
    'registre': [
        'RC 1234567',
        'Ø± Ù‚  Ù¡Ù¢Ù£ Ù¤Ù¥ Ù¦',
        'Registre de commerce 123 456',
        'Ø± Ù‚123456',
        'RC123 456',
        'Ø± Ù‚ 123456',
    ]
})

# Remove all spaces from the column
df['registre'] = df['registre'].str.replace(r'\s+', '', regex=True)

print(df)





import pandas as pd

# Sample DataFrame with "Registre de commerce" values
df = pd.DataFrame({
    'registre': [
        'RC 1234567',
        'Ø± Ù‚  Ù¡Ù¢Ù£ Ù¤Ù¥ Ù¦',
        'Registre de commerce 123 456',
        'Ø± Ù‚123456',
        'RC123 456',
        'Ø± Ù‚ 123456',
    ]
})

# Remove all spaces from the column
df['registre'] = df['registre'].str.replace(r'\s+', '', regex=True)

print(df)

# Arabic letters pattern
arabic_letters = 'Ø§Ø£Ø¥Ø¢Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙŠ'
pattern = f'([{arabic_letters}])\\s+'

# Remove only the space that comes after an Arabic letter
df['text'] = df['text'].str.replace(pattern, r'\1', regex=True)

print(df)




Objet : Demande de relevÃ©s de compte (Dinars et Euros)

Bonjour Amina,

Pourrais-tu, sâ€™il te plaÃ®t, mâ€™envoyer mes relevÃ©s de compte en Dinars et en Euros des trois derniers mois ?
Merci de les transmettre au service Data HO, au 7áµ‰ Ã©tage.

Je te remercie par avance pour ton aide.

Bien cordialement,
Nihad Senhadji
