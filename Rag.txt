
import os
import pandas as pd
import xlwings as xw

def fill_excel_from_csv(csv_path, excel_folder, output_folder):
    # === Ensure output folder exists
    os.makedirs(output_folder, exist_ok=True)

    # === RC column variations (in Excel)
    rc_cols = [
        "RC", "Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ", "Registre de commerce (extracted)",
        "Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„", "Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ", "NÂ° du registre du commerce", "Ø±Ù‚Ù… Ø³Øª"
    ]

    # === Arabic Excel column names
    loan_yn_cols = ["Ù‡Ù„ Ø§Ø³ØªÙØ§Ø¯ Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„ Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ù…Ù† Ù‚Ø±Ø¶ Ø¨Ù†ÙƒÙŠ"]
    loan_date_cols = ["ØªØ§Ø±ÙŠØ® Ø§Ø®Ø± Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ù‚Ø±Ø¶ Ø¨Ù†ÙƒÙŠ"]
    bank_dom_yn_cols = ["Ù‡Ù„ Ù‚Ø§Ù… Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„ Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ø¨ØªÙˆØ·ÙŠÙ† Ø¨Ù†ÙƒÙŠ Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ø³ØªÙŠØ±Ø§Ø¯"]
    bank_dom_date_cols = ["ØªØ§Ø±ÙŠØ® Ø§Ø®Ø± Ø¨ØªÙˆØ·ÙŠÙ† Ø¨Ù†ÙƒÙŠ Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ø³ØªÙŠØ±Ø§Ø¯"]

    # === CSV to Excel column mapping
    csv_column_map = {
        "beneficiaire credit": ("loan_yn", {"Oui": "Ù†Ø¹Ù…", "Non": "Ù„Ø§"}),
        "Derniere date effet crÃ©dit": ("loan_date", None),
        "Operation import": ("bank_dom_yn", {"Oui": "Ù†Ø¹Ù…", "Non": "Ù„Ø§"}),
        "Derniere date import": ("bank_dom_date", None)
    }

    # === Load CSV
    csv_df = pd.read_csv(csv_path, dtype=str).fillna("")
    if "Registre_commerce" not in csv_df.columns:
        print("âŒ 'Registre_commerce' column not found in CSV.")
        return

    csv_df.set_index("Registre_commerce", inplace=True)

    # === Loop over Excel files
    for filename in os.listdir(excel_folder):
        if not filename.endswith(".xlsx"):
            continue

        file_path = os.path.join(excel_folder, filename)
        output_path = os.path.join(output_folder, filename)
        print(f"\nğŸ“„ Processing: {filename}")

        updated = False
        app = xw.App(visible=False)

        try:
            wb = app.books.open(file_path)

            for sheet in wb.sheets:
                header_row = None
                header_map = {}

                # === Detect header row (within first 50 rows)
                for row_num in range(1, 51):
                    values = sheet.range(f"A{row_num}").expand("right").value
                    if not values:
                        continue
                    if any(str(cell).strip() in rc_cols for cell in values if cell):
                        header_row = row_num
                        break

                if not header_row:
                    print(f"âš ï¸  No RC header in sheet '{sheet.name}'")
                    continue

                headers = sheet.range(f"A{header_row}").expand("right").value

                # === Map header indexes
                for idx, col in enumerate(headers):
                    col = str(col).strip()
                    if col in rc_cols:
                        header_map["Registre_commerce"] = idx + 1
                    elif col in loan_yn_cols:
                        header_map["loan_yn"] = idx + 1
                    elif col in loan_date_cols:
                        header_map["loan_date"] = idx + 1
                    elif col in bank_dom_yn_cols:
                        header_map["bank_dom_yn"] = idx + 1
                    elif col in bank_dom_date_cols:
                        header_map["bank_dom_date"] = idx + 1

                if "Registre_commerce" not in header_map:
                    print(f"âŒ RC column not found in sheet '{sheet.name}'")
                    continue

                # === Process data rows
                row = header_row + 1
                while True:
                    cell = sheet.range((row, header_map["Registre_commerce"])).value
                    if not cell:
                        break

                    rc = str(cell).strip()
                    if rc in csv_df.index:
                        for csv_col, (target_col, map_vals) in csv_column_map.items():
                            if target_col in header_map and csv_col in csv_df.columns:
                                value = csv_df.at[rc, csv_col]
                                if map_vals:
                                    value = map_vals.get(value.strip(), "")
                                sheet.range((row, header_map[target_col])).value = value
                                updated = True
                    row += 1

            if updated:
                wb.save(output_path)
                print(f"âœ… Saved: {output_path}")
            else:
                print("â„¹ï¸  No updates made.")

            wb.close()

        finally:
            app.quit()
