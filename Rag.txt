import fitz  # PyMuPDF
import re
import os

# Function to extract text and images from each page in the PDF
def extract_text_and_images(pdf_path):
    doc = fitz.open(pdf_path)
    
    all_text = ""
    images = []
    
    for page_num in range(len(doc)):
        page = doc.load_page(page_num)
        
        # Extract text from the page
        page_text = page.get_text("text")
        all_text += page_text  # Add text from this page to all_text
        
        # Extract images from the page
        image_list = page.get_images(full=True)
        for img_index, img in enumerate(image_list):
            xref = img[0]
            base_image = doc.extract_image(xref)
            image_data = base_image["image"]  # Binary image data
            images.append(image_data)
    
    return all_text, images

# Function to identify tables in the text (basic pattern detection)
def identify_tables(text):
    # Example: Look for common table patterns like rows and columns
    rows = text.split("\n")
    table_data = []
    for row in rows:
        # Split each row by whitespace or tabs (based on PDF formatting)
        columns = re.split(r'\s{2,}', row.strip())  # Assuming columns are separated by at least two spaces
        if len(columns) > 1:  # Heuristic: rows with multiple columns might be tables
            table_data.append(columns)
    
    return table_data

# Function to process the entire PDF
def process_pdf(pdf_path, output_dir="output"):
    # Ensure output directory exists
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)
    
    # Extract text and images from the PDF
    text, images = extract_text_and_images(pdf_path)
    
    # Identify tables in the extracted text
    table_data = identify_tables(text)
    
    # Save the identified tables to a file (optional)
    table_file = os.path.join(output_dir, "tables.txt")
    with open(table_file, "w") as f:
        for table in table_data:
            f.write("\t".join(table) + "\n")
    
    print(f"Extracted {len(table_data)} tables from the PDF.")
    
    # Optionally save the images to separate files
    for i, image_data in enumerate(images):
        image_file = os.path.join(output_dir, f"image_{i + 1}.png")
        with open(image_file, "wb") as img_f:
            img_f.write(image_data)
    
    print(f"Extracted {len(images)} images from the PDF and saved them.")

# Example usage
pdf_path = "your_pdf_file.pdf"  # Replace with your PDF file path
process_pdf(pdf_path)
