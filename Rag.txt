import os
import pandas as pd

# Root folder where Excel files are located
root_folder = "/mnt/sheets/Liste des personnes physiques-morales non localiser"

# Container for summary info
sheet_summary = []

# Loop through all subdirectories and files
for dirpath, dirnames, filenames in os.walk(root_folder):
    for file in filenames:
        if file.endswith((".xlsx", ".xls")) and not file.startswith("-5"):
            file_path = os.path.join(dirpath, file)
            try:
                xls = pd.ExcelFile(file_path)
                for sheet_name in xls.sheet_names:
                    try:
                        df = pd.read_excel(file_path, sheet_name=sheet_name, dtype=str, header=None)
                        # Fill NaNs and convert the entire sheet to a single string
                        sheet_content = df.fillna("").astype(str).apply(lambda x: "|".join(x), axis=1).str.cat(sep="\n")
                        sheet_summary.append({
                            "FileName": file,
                            "SheetName": sheet_name,
                            "FilePath": file_path,
                            "SheetContent": sheet_content
                        })
                    except Exception as e:
                        print(f"Error reading sheet '{sheet_name}' in {file}: {e}")
            except Exception as e:
                print(f"Error opening file '{file}': {e}")

# Convert to DataFrame and export
if sheet_summary:
    summary_df = pd.DataFrame(sheet_summary)

    # Save to CSV
    csv_output_path = "/mnt/excel_sheet_summaries.csv"
    summary_df.to_csv(csv_output_path, index=False)
    print(f"Sheet summaries saved to: {csv_output_path}")

    # Save to TXT
    txt_output_path = "/mnt/excel_sheet_summaries.txt"
    with open(txt_output_path, "w", encoding="utf-8") as f:
        for entry in sheet_summary:
            f.write(f"FileName: {entry['FileName']}\n")
            f.write(f"SheetName: {entry['SheetName']}\n")
            f.write(f"FilePath: {entry['FilePath']}\n")
            f.write(f"SheetContent:\n{entry['SheetContent']}\n")
            f.write("="*80 + "\n")
    print(f"Sheet summaries also saved to: {txt_output_path}")
else:
    print("No sheets found or readable.")

