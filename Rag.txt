import base64
import tempfile
from gtts import gTTS
from fpdf import FPDF
import streamlit as st

# Extract assistant message
assistant_message = response["answer"]
sources = response.get("sources", "")
evaluation = response.get("evaluation", "")
full_text = f"Réponse:\n{assistant_message}\n\nSources:\n{sources}\n\nÉvaluation:\n{evaluation}"

# Save the assistant message
st.session_state.chat_sessions[st.session_state.current_chat].append({
    "role": "assistant",
    "content": assistant_message,
    "sources": sources,
    "evaluation": evaluation
})

# Show the assistant response
st.markdown(f"**Assistant:** {assistant_message}")

# --- 📋 Copy Button (using text area hack) ---
st.text_area("📋 Copier la réponse", assistant_message, height=150)

# --- 📥 Download PDF ---
def generate_pdf(text):
    pdf = FPDF()
    pdf.add_page()
    pdf.set_auto_page_break(auto=True, margin=15)
    pdf.set_font("Arial", size=12)
    for line in text.split('\n'):
        pdf.multi_cell(0, 10, line)
    with tempfile.NamedTemporaryFile(delete=False, suffix=".pdf") as tmp_file:
        pdf.output(tmp_file.name)
        return tmp_file.name

pdf_path = generate_pdf(full_text)
with open(pdf_path, "rb") as f:
    st.download_button("📄 Télécharger la réponse en PDF", f, file_name="reponse.pdf", mime="application/pdf")

# --- 🔊 Voice Cover (French) ---
def play_tts(text, lang='fr'):
    tts = gTTS(text, lang=lang)
    with tempfile.NamedTemporaryFile(delete=False, suffix=".mp3") as fp:
        tts.save(fp.name)
        audio_file = fp.name
    st.audio(audio_file, format='audio/mp3')

play_tts(assistant_message)





def generate_response(prompt, context):
    try:
        completion = openai.ChatCompletion.create(
            engine="gpt-35-turbo",
            messages=[
                {"role": "system", "content": "You are a helpful assistant."},
                {"role": "user", "content": context},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=500
        )
        return {"success": True, "answer": completion.choices[0].message.content}
    except Exception as e:
        return {"success": False, "answer": str(e)}




import streamlit as st
from PIL import Image
from datetime import datetime
import pandas as pd
import os
import pyttsx3

# Initialize TTS engine
engine = pyttsx3.init()
engine.setProperty('voice', 'french')  # Try setting a French voice if available
engine.setProperty('rate', 150)

# Dummy RAG chatbot response function (replace with your actual function)
def rag_chatbot(user_input):
    return {
        "answer": f"Réponse à : {user_input}",
        "sources": ["Document 1", "Document 2"],
        "evaluation": "Pertinent"
    }

# Save feedback to CSV
def save_feedback(chat_id, message_index, feedback_type):
    feedback_file = "chat_feedback.csv"
    data = {
        "chat_id": chat_id,
        "message_index": message_index,
        "feedback": feedback_type,
        "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    }
    df = pd.DataFrame([data])
    if os.path.exists(feedback_file):
        df.to_csv(feedback_file, mode="a", header=False, index=False)
    else:
        df.to_csv(feedback_file, index=False)

# Play French response using TTS
def speak_text(text):
    engine.say(text)
    engine.runAndWait()

# Load logo
image = Image.open("/mnt/logo-banque.png")
st.image(image)

# Initialize session state
if "chat_sessions" not in st.session_state:
    st.session_state.chat_sessions = {}

if "current_chat" not in st.session_state:
    st.session_state.current_chat = None

# Sidebar: Chat session management
with st.sidebar:
    st.header("Chat Sessions")
    
    if st.button("+ New Chat"):
        chat_id = len(st.session_state.chat_sessions) + 1
        chat_name = f"Chat {chat_id}"
        st.session_state.chat_sessions[chat_name] = []
        st.session_state.current_chat = chat_name
    
    if st.session_state.chat_sessions:
        options = []
        for key, messages in st.session_state.chat_sessions.items():
            label = key
            for m in messages:
                if m["role"] == "user":
                    label = m["content"][:30] + "..." if len(m["content"]) > 30 else m["content"]
                    break
            options.append(f"{key}: {label}")
        
        selected = st.radio("Select Chat", options)
        selected_key = selected.split(":")[0]
        st.session_state.current_chat = selected_key

# Main chat interface
st.title("RAG Chatbot")

if st.session_state.current_chat:
    chat = st.session_state.chat_sessions[st.session_state.current_chat]

    # Display chat history
    for i, message in enumerate(chat):
        with st.chat_message(message["role"]):
            if message["role"] == "user" and "timestamp" in message:
                st.markdown(f"**[{message['timestamp']}]**")
            st.markdown(message["content"])

            if message["role"] == "assistant":
                with st.expander("Details"):
                    st.write("**Sources:**", message["sources"])
                    st.write("**Evaluation:**", message["evaluation"])

                # Feedback buttons
                col1, col2 = st.columns([1, 1])
                with col1:
                    if st.button("👍", key=f"up_{i}"):
                        save_feedback(st.session_state.current_chat, i, "up")
                with col2:
                    if st.button("👎", key=f"down_{i}"):
                        save_feedback(st.session_state.current_chat, i, "down")

# Input area
user_input = st.chat_input("Type your message here...")
if user_input and st.session_state.current_chat:
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    # Add user message
    st.session_state.chat_sessions[st.session_state.current_chat].append({
        "role": "user",
        "content": user_input,
        "timestamp": timestamp
    })

    # Process response
    with st.spinner("Thinking..."):
        response = rag_chatbot(user_input)

    # Add assistant message
    st.session_state.chat_sessions[st.session_state.current_chat].append({
        "role": "assistant",
        "content": response["answer"],
        "sources": response["sources"],
        "evaluation": response["evaluation"]
    })

    # Speak the response aloud
    speak_text(response["answer"])

    st.rerun()


import streamlit as st
from PIL import Image
from datetime import datetime
import pandas as pd
import os
from gtts import gTTS
import base64

# Dummy RAG chatbot response function (replace with your actual function)
def rag_chatbot(user_input):
    return {
        "answer": f"Réponse à : {user_input}",
        "sources": ["Document 1", "Document 2"],
        "evaluation": "Pertinent"
    }

# Generate French voice from text
def generate_audio(text, lang="fr"):
    tts = gTTS(text, lang=lang)
    tts.save("response.mp3")
    with open("response.mp3", "rb") as f:
        audio_bytes = f.read()
        b64 = base64.b64encode(audio_bytes).decode()
        return f'<audio controls autoplay><source src="data:audio/mp3;base64,{b64}" type="audio/mp3"></audio>'

# Save feedback to CSV
def save_feedback(chat_id, message_index, feedback_type):
    feedback_file = "chat_feedback.csv"
    data = {
        "chat_id": chat_id,
        "message_index": message_index,
        "feedback": feedback_type,
        "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    }
    df = pd.DataFrame([data])
    
    if os.path.exists(feedback_file):
        df.to_csv(feedback_file, mode="a", header=False, index=False)
    else:
        df.to_csv(feedback_file, index=False)

# Load logo
image = Image.open("/mnt/logo-banque.png")
st.image(image)

# Initialize session state
if "chat_sessions" not in st.session_state:
    st.session_state.chat_sessions = {}

if "current_chat" not in st.session_state:
    st.session_state.current_chat = None

# Sidebar: Chat session management
with st.sidebar:
    st.header("Chat Sessions")
    
    if st.button("+ New Chat"):
        chat_id = len(st.session_state.chat_sessions) + 1
        chat_name = f"Chat {chat_id}"
        st.session_state.chat_sessions[chat_name] = []
        st.session_state.current_chat = chat_name
    
    if st.session_state.chat_sessions:
        options = []
        for key, messages in st.session_state.chat_sessions.items():
            label = key
            for m in messages:
                if m["role"] == "user":
                    label = m["content"][:30] + "..." if len(m["content"]) > 30 else m["content"]
                    break
            options.append(f"{key}: {label}")
        
        selected = st.radio("Select Chat", options)
        selected_key = selected.split(":")[0]
        st.session_state.current_chat = selected_key

# Main chat interface
st.title("RAG Chatbot")

if st.session_state.current_chat:
    chat = st.session_state.chat_sessions[st.session_state.current_chat]

    # Display chat history
    for i, message in enumerate(chat):
        with st.chat_message(message["role"]):
            if message["role"] == "user" and "timestamp" in message:
                st.markdown(f"**[{message['timestamp']}]**")
            st.markdown(message["content"])

            if message["role"] == "assistant":
                if "timestamp" in message:
                    st.markdown(f"**[{message['timestamp']}]**")

                # Audio playback
                audio_html = generate_audio(message["content"])
                st.markdown(audio_html, unsafe_allow_html=True)

                with st.expander("Details"):
                    st.write("**Sources:**", message["sources"])
                    st.write("**Evaluation:**", message["evaluation"])
                
                # Rating thumbs
                col1, col2 = st.columns([1, 1])
                with col1:
                    if st.button("👍", key=f"up_{i}"):
                        save_feedback(st.session_state.current_chat, i, "up")
                with col2:
                    if st.button("👎", key=f"down_{i}"):
                        save_feedback(st.session_state.current_chat, i, "down")

# Input area
user_input = st.chat_input("Type your message here...")
if user_input and st.session_state.current_chat:
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    # Add user message
    st.session_state.chat_sessions[st.session_state.current_chat].append({
        "role": "user",
        "content": user_input,
        "timestamp": timestamp
    })

    # Process response
    with st.spinner("Thinking..."):
        response = rag_chatbot(user_input)

    # Add assistant message
    st.session_state.chat_sessions[st.session_state.current_chat].append({
        "role": "assistant",
        "content": response["answer"],
        "sources": response["sources"],
        "evaluation": response["evaluation"],
        "timestamp": timestamp
    })

    st.rerun()





import streamlit as st
from PIL import Image
from datetime import datetime
import pandas as pd
import os

# Dummy RAG chatbot response function (replace with your actual function)
def rag_chatbot(user_input):
    return {
        "answer": f"Response to: {user_input}",
        "sources": ["Document 1", "Document 2"],
        "evaluation": "Relevant"
    }

# Load logo
image = Image.open("/mnt/logo-banque.png")
st.image(image)

# Initialize session state
if "chat_sessions" not in st.session_state:
    st.session_state.chat_sessions = {}

if "current_chat" not in st.session_state:
    st.session_state.current_chat = None

# Sidebar: Chat session management
with st.sidebar:
    st.header("Chat Sessions")
    
    if st.button("+ New Chat"):
        chat_id = len(st.session_state.chat_sessions) + 1
        chat_name = f"Chat {chat_id}"
        st.session_state.chat_sessions[chat_name] = []
        st.session_state.current_chat = chat_name
    
    if st.session_state.chat_sessions:
        options = []
        for key, messages in st.session_state.chat_sessions.items():
            label = key
            for m in messages:
                if m["role"] == "user":
                    label = m["content"][:30] + "..." if len(m["content"]) > 30 else m["content"]
                    break
            options.append(f"{key}: {label}")
        
        selected = st.radio("Select Chat", options)
        selected_key = selected.split(":")[0]
        st.session_state.current_chat = selected_key

# Main chat interface
st.title("RAG Chatbot")

if st.session_state.current_chat:
    chat = st.session_state.chat_sessions[st.session_state.current_chat]

    # Display chat history
    for i, message in enumerate(chat):
        with st.chat_message(message["role"]):
            if message["role"] == "user" and "timestamp" in message:
                st.markdown(f"**[{message['timestamp']}]**")
            st.markdown(message["content"])

            if message["role"] == "assistant":
                with st.expander("Details"):
                    st.write("**Sources:**", message["sources"])
                    st.write("**Evaluation:**", message["evaluation"])
                
                # Rating thumbs
                col1, col2 = st.columns([1, 1])
                with col1:
                    if st.button("👍", key=f"up_{i}"):
                        save_feedback(st.session_state.current_chat, i, "up")
                with col2:
                    if st.button("👎", key=f"down_{i}"):
                        save_feedback(st.session_state.current_chat, i, "down")

# Input area
user_input = st.chat_input("Type your message here...")
if user_input and st.session_state.current_chat:
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    # Add user message
    st.session_state.chat_sessions[st.session_state.current_chat].append({
        "role": "user",
        "content": user_input,
        "timestamp": timestamp
    })

    # Process response
    with st.spinner("Thinking..."):
        response = rag_chatbot(user_input)

    # Add assistant message
    st.session_state.chat_sessions[st.session_state.current_chat].append({
        "role": "assistant",
        "content": response["answer"],
        "sources": response["sources"],
        "evaluation": response["evaluation"]
    })

    st.rerun()

# Save feedback to CSV
def save_feedback(chat_id, message_index, feedback_type):
    feedback_file = "chat_feedback.csv"
    data = {
        "chat_id": chat_id,
        "message_index": message_index,
        "feedback": feedback_type,
        "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    }
    df = pd.DataFrame([data])
    
    if os.path.exists(feedback_file):
        df.to_csv(feedback_file, mode="a", header=False, index=False)
    else:
        df.to_csv(feedback_file, index=False)






# --- Input area ---
user_input = st.chat_input("Type your message here...")

if user_input and st.session_state.current_chat:
    # Add user message to chat history
    st.session_state.chat_sessions[st.session_state.current_chat].append({
        "role": "user",
        "content": user_input
    })

    # Process query with spinner
    with st.spinner("Thinking..."):
        response = rag_chatbot(user_input)  # Make sure `rag_chatbot()` is defined elsewhere

    # Add assistant response to chat history
    st.session_state.chat_sessions[st.session_state.current_chat].append({
        "role": "assistant",
        "content": response.get("answer", "No response."),
        "sources": response.get("sources", []),
        "evaluation": response.get("evaluation", "N/A")
    })

    # Rerun to update the chat display
    st.rerun()




import streamlit as st
from PIL import Image

# --- Initialize session state variables ---
if "chat_sessions" not in st.session_state:
    st.session_state.chat_sessions = {}

if "current_chat" not in st.session_state:
    st.session_state.current_chat = None

# --- Load and display logo ---
image = Image.open("/mnt/logo-banque.png")
st.image(image)

# --- Sidebar: Chat session controls ---
with st.sidebar:
    st.header("Chat Sessions")

    # Create new chat
    if st.button("+ New Chat"):
        new_chat_name = f"Chat {len(st.session_state.chat_sessions) + 1}"
        st.session_state.chat_sessions[new_chat_name] = []
        st.session_state.current_chat = new_chat_name

    # Display and select existing chats
    if st.session_state.chat_sessions:
        selected_chat = st.radio(
            "Select Chat",
            options=list(st.session_state.chat_sessions.keys()),
            index=0 if st.session_state.current_chat is None else list(st.session_state.chat_sessions.keys()).index(st.session_state.current_chat)
        )
        st.session_state.current_chat = selected_chat

# --- Main chat interface ---
st.title("RAG Chatbot")

# Display chat history
chat_container = st.container()

with chat_container:
    if st.session_state.current_chat:
        for message in st.session_state.chat_sessions[st.session_state.current_chat]:
            with st.chat_message(message["role"]):
                st.markdown(message["content"])

                if message["role"] == "assistant":
                    with st.expander("Details"):
                        st.write("**Sources:**", message.get("sources", "N/A"))
                        st.write("**Evaluation:**", message.get("evaluation", "N/A"))
    else:
        st.info("Please start a new chat or select an existing one.")


