from fpdf import FPDF
import base64

def show_copy_and_download_buttons(answer_text: str):
    # === PDF creation
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", size=12)
    for line in answer_text.split("\n"):
        pdf.multi_cell(0, 10, line)
    pdf_bytes = pdf.output(dest="S").encode("latin-1")

    # === PDF download button
    st.download_button(
        label="üì• Download Answer as PDF",
        data=pdf_bytes,
        file_name="answer.pdf",
        mime="application/pdf"
    )
import streamlit.components.v1 as components

def show_copy_button(text_to_copy: str):
    components.html(f"""
        <script>
        function copyText() {{
            const text = `{text_to_copy}`;
            navigator.clipboard.writeText(text).then(function() {{
                alert("‚úÖ Answer copied to clipboard!");
            }}, function(err) {{
                alert("‚ùå Failed to copy text: " + err);
            }});
        }}
        </script>
        <button onclick="copyText()" style="
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
        ">üìã Copy Answer to Clipboard</button>
    """, height=50)



if user_input:
    handle_chat_history(user_input=user_input)

    with st.chat_message("assistant"):
        with st.spinner("Thinking..."):
            response = rag_chatbot(user_input, temp_chunks=temp_chunks)
            answer = response["answer"]

            st.markdown(answer, unsafe_allow_html=True)

            st.session_state["last_answer"] = answer  # üíæ Save for reuse
            handle_chat_history(response=answer)

# === Show Copy & Download Buttons if answer exists
if "last_answer" in st.session_state:
    show_copy_button(st.session_state["last_answer"])
    show_copy_and_download_buttons(st.session_state["last_answer"])










def show_copy_and_download_buttons(answer_text):
    # === Manual Copy Option
    with st.expander("üìã Copy Answer"):
        st.text_area("Copy the answer manually:", value=answer_text, height=200)

    # === PDF Download
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", size=12)
    for line in answer_text.split("\n"):
        pdf.multi_cell(0, 10, line)

    pdf_bytes = pdf.output(dest="S").encode("latin-1")  # Fresh bytes each time

    st.download_button(
        label="üì• Download Answer as PDF",
        data=pdf_bytes,
        file_name="answer.pdf",
        mime="application/pdf"
    )



def create_pdf_from_text(text):
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", size=12)

    for line in text.split("\n"):
        pdf.multi_cell(0, 10, line)

    # Generate PDF as string
    pdf_output = pdf.output(dest='S').encode('latin-1')  # PDF raw bytes
    return pdf_output



def show_copy_and_download_buttons(answer_text):
    # Copy to clipboard (browser only)
    st.markdown(
        f"""
        <button onclick="navigator.clipboard.writeText(`{answer_text}`)"
        style="background-color:#4CAF50;color:white;padding:10px;border:none;border-radius:5px;margin-bottom:10px;">
        üìã Copy Answer to Clipboard
        </button>
        """,
        unsafe_allow_html=True,
    )

    # PDF download
    pdf_bytes = create_pdf_from_text(answer_text)
    st.download_button(
        label="üì• Download Answer as PDF",
        data=pdf_bytes,
        file_name="answer.pdf",
        mime="application/pdf"
    )



